#psql #replication

В новой версии PostgreSQL 12+ процесс настройки репликации отличается от того, что было ранее:

- файл `recovery.conf` теперь отсутствует
- параметр `standby_mode` выпилен, вместо него файл в корне файл `standby.signal` теперь уведомляет, что сервер standby (slave)
- в файл `postgresql.auto.conf` пишется `primary_conninfo` – инфа о мастере и пароле, которая ранее была в `recovery.conf`. Причем `postgresql.auto.conf` – это файл конфигурации, который читается в конце при запуске Postgres. Таким образом, если есть параметр, который имеет разные значения в файлах `postgresql.conf` и `postgresql.auto.conf`, значение, установленное в `postgresql.auto.conf`, рассматривается PostgreSQL в приоритете. Кроме того, любой параметр, который был изменен с помощью `ALTER SYSTEM`, будет автоматически записан также в `postgresql.auto.conf`.

## Promotion slave to master

В случае возникновения проблем с мастер-сервером, можно переключить работу приложения на слейв сервер. Но для этого необходимо указать slave-серверу, что он теперь станет ведущим и может выполнять запись, т.е. выполнить promote. В Postgresql 12 есть три способа выполнить promotion для slave-сервера:

1. Создать пустой файл с любым именем по пути, указанному в параметре `promote_trigger_file` конфигурационного файла `postgresql.con`f. При этом файл standby.signal будет удален.
2. Запустить команду `pg_ctl promote` (в контейнере с postgresql она уже установлена)
3. В консоли postgresql вызвать функцию `select pg_promote();`

Во втором и третьем случаях никакие файлы создавать не потребуется.