#psql #lock


- LWLOCK -легкие - нет мониторинга, нечестная очередь ожидания
- HWLOCK (LOCK) - тяжелые - мониторинг, честная очередь, тратится больше ресурсов на обслуживание

### Семплинг
Есть расширения `pg_wait_sampling`, которое может **периодически** смотреть в таблицы
```SQL
SELCT p.pid, a.backend_type, p.event_type, p.event, p.count
FROM pg_wait_sampling_profile p
	LEFT JOIN pg_stat_activity a ON p.pid = a.pid;
```

### Buffer mapping lock
#patch

В ОЗУ есть хэш-таблица, с ссылками на страницы кэша psql. На хэш-таблицу наложен лок, для читателей shared, для писателей монопольный. Но очередь ожидания не честная.
Приходящие процессы, которые хотят читать таблицу, получают блокировку без очереди, ототдвигая таким образом процессы, которые хотят изменить хэш-таблицу.
В общем случаем такое поведение норм, но в некоторых случаях производительность может просесть. Это происходит, когда читетелей очень большое кол-во. Есть патч Александра Короткова, но не стоит его использовать везде, только если есть проблема с этими блокировками!
https://www.postgresql.org/message-id/flat/CAPpHfdvJhO1qutziOp=dy8TO8Xb4L38BxgKG4RPa1up1Lzh_UQ@mail.gmail.com
[[psql_patch_korotkov_buffer_mapping_lock.pdf]]

Саму хэш-таблицу распилили на 16 частей еще в psql 8.2, а потом и на большее кол-во частей (128 и тд). Это позволяет делать независимые локи на каждой части хэш-таблицы, увеличивая пропускную способность.